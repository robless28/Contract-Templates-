<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Contract Generator — Bilingual + Two-step Jurisdiction</title>
<style>
  :root {
    --contract-width: 800px;
    --line-color: #222;
  }
  body { font-family: Georgia, "Times New Roman", serif; margin: 20px; background: #f6f7f8; color: #111; }
  header { margin-bottom: 8px; }
  .container { display:flex; gap:28px; align-items:flex-start; }
  .form-section { flex:1; max-width:420px; background:#fff; padding:18px; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
  .preview-section { flex:2; max-width:calc(var(--contract-width) + 40px); padding:20px; height:90vh; overflow-y:auto; }
  label { display:block; margin-top:12px; font-weight:bold; font-size:14px; }
  input[type="text"], input[type="number"], input[type="date"], select, input[readonly] {
    width:100%; padding:8px 10px; margin-top:6px; font-size:14px; box-sizing:border-box; border:1px solid #d7d7d7; border-radius:6px; background:#fff;
  }
  input[readonly] { background:#f2f2f2; color:#222; }
  .required::after { content:" *"; color:#d00; }
  button { margin-top:18px; padding:10px 16px; font-size:15px; border-radius:6px; border:none; cursor:pointer; background:#0b3d91; color:white; }
  .muted-small { font-size:12px; color:#666; margin-top:6px; }

  /* popup */
  .preview-popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:2px solid #0b3d91; width:85vw; height:85vh; overflow-y:auto; z-index:2000; padding:20px; display:none; flex-direction:column; box-shadow:0 12px 40px rgba(0,0,0,0.25); }
  .preview-popup-header { display:flex; justify-content:space-between; align-items:center; }
  .close-preview { cursor:pointer; font-size:22px; color:#0b3d91; }

  /* contract-like styling */
  .contract-document { width:var(--contract-width); margin:12px auto; padding:48px; background:#fff; border:1px solid #ddd; box-shadow:0 10px 30px rgba(0,0,0,0.06); font-size:15px; line-height:1.6; color:#111; }
  .contract-document h2 { font-size:20px; margin-bottom:6px; }
  .contract-document h3 { font-size:16px; margin-top:18px; margin-bottom:6px; }
  .contract-document p { text-align: justify; margin:8px 0; }
  .contract-document .clause { margin-top:10px; }
  .contract-document .sign-line { display:flex; gap:20px; margin-top:28px; align-items:baseline; }
  .sign-slot { flex:1; text-align:center; }
  .signature { display:block; margin-top:22px; border-bottom:2px solid #111; height:1px; }
  .signature-label { margin-top:8px; display:block; font-weight:600; }

  /* placeholder */
  .placeholder { display:inline-block; color:var(--line-color); font-weight:600; letter-spacing:1px; white-space:nowrap; }
  .contract-preview.dimmed { opacity:0.95; }

  @media (max-width:1000px) {
    .container { flex-direction:column; }
    .preview-section { max-width:100%; padding:12px; }
    .contract-document { width:100%; padding:24px; }
  }
</style>
</head>
<body>
<header>
  <a href="../index.html" style="color:#0b3d91; text-decoration:none; font-size:18px;">← Back to Home</a>
  <h1 style="margin-top:8px">Contract Generator</h1>
  <p class="muted-small">Live bilingual contract preview. Switch language (English / Español) — UI labels remain English.</p>
</header>

<!-- Controls -->
<label for="contractType" class="required">Select Contract Type</label>
<select id="contractType" required>
  <option value="">-- Choose a contract --</option>
  <option value="realEstate">Real Estate Sale Contract</option>
  <option value="lease">Lease Contract</option>
  <option value="mortgage">Mortgage Contract</option>
</select>

<div class="container">
  <form id="contractForm" class="form-section" onsubmit="return false;">
    <div style="display:flex; gap:10px; align-items:center;">
      <div style="flex:1;">
        <label for="regionSelect">Region</label>
        <select id="regionSelect">
          <option value="">-- Select Region --</option>
          <option value="Texas">Texas</option>
          <option value="Mexico">Mexico</option>
        </select>
      </div>
      <div style="flex:1;">
        <label for="courtSelect">Court</label>
        <select id="courtSelect">
          <option value="">-- Select Court --</option>
        </select>
      </div>
    </div>

    <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
      <div style="flex:1;">
        <label for="languageSelect">Contract Language</label>
        <select id="languageSelect" title="Contract wording language">
          <option value="en">English</option>
          <option value="es">Español</option>
        </select>
      </div>
      <div style="flex:1;">
        <label class="muted-small"> </label>
        <div class="muted-small">Language affects contract text only.</div>
      </div>
    </div>

    <div id="dynamicFieldsNote" class="muted-small" style="margin-top:10px;">Select a contract above to begin.</div>
  </form>

  <div class="preview-section" id="previewSection">
    <em>Select a contract and fill out the form to see the live contract preview here.</em>
  </div>
</div>

<div style="margin-top:14px;">
  <button id="showPreviewBtn" disabled>Show Popup Preview</button>
  <button id="downloadPdfBtn" disabled style="margin-left:8px;">Download PDF</button>
</div>

<!-- Popup preview -->
<div class="preview-popup" id="previewPopup">
  <div class="preview-popup-header">
    <h2>Contract Preview</h2>
    <span class="close-preview" id="closePreviewBtn">&times;</span>
  </div>
  <div id="popupContent" style="overflow-y:auto; flex-grow:1; margin-top:10px;"></div>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
/* ---------------------------
   Jurisdiction lists & Contracts
   --------------------------- */
const regionCourtMap = {
  "Texas": [
    "Local Court (Texas)",
    "County Court (Texas)",
    "State Court (Texas)",
    "Federal Court (Texas)",
    "Supreme Court of Texas"
  ],
  "Mexico": [
    "Local Court (Mexico)",
    "County Court (Mexico)",
    "State Court (Mexico)",
    "Federal Court (Mexico)",
    "Supreme Court of Mexico"
  ]
};

const contracts = {
  realEstate: {
    title: { en: "Real Estate Sale Contract", es: "Contrato de Compraventa Inmobiliaria" },
    fields: [
      { name:"CITY", label:"City", type:"text", required:true },
      { name:"DATE", label:"Date", type:"date", required:true },
      { name:"SELLER_NAME", label:"Seller Full Name", type:"text", required:true },
      { name:"BUYER_NAME", label:"Buyer Full Name", type:"text", required:true },
      { name:"PROPERTY_TYPE", label:"Property Type", type:"select", options:["House","Apartment","Land","Business","Car"], required:true },
      { name:"PROPERTY_ADDRESS", label:"Property Address", type:"text", required:true },
      { name:"PROPERTY_DESCRIPTION", label:"Property Description", type:"text", required:true },
      { name:"PRICE_AMOUNT", label:"Price Amount", type:"number", prefix:"$", required:true },
      { name:"PAYMENT_TYPE", label:"Payment Type", type:"select", options:["Cash","Card","Check"], required:true },
      // Jurisdiction will be populated from region/court selects
      { name:"JURISDICTION", label:"Jurisdiction", type:"text", required:true }
    ],
    template: function(data, lang) {
      // data: object; lang: 'en'|'es'
      if (lang === 'es') {
        return `
          <div class="contract-document contract-preview dimmed">
            <h2>${escapeHtml(this.title.es)}</h2>
            <p>En <strong>${helpers.placeholderFormatted(data.CITY,'city')}</strong> a <strong>${helpers.placeholderFormattedDate(data.DATE)}</strong>.</p>
            <p>Comparecen: <strong>${helpers.placeholderFormatted(data.SELLER_NAME,'name')}</strong> (el "Vendedor") y <strong>${helpers.placeholderFormatted(data.BUYER_NAME,'name')}</strong> (el "Comprador").</p>
            <h3>Declaraciones:</h3>
            <p>El Vendedor declara ser el propietario legal del bien (${helpers.placeholderFormatted(data.PROPERTY_TYPE,'short')}) ubicado en <strong>${helpers.placeholderFormatted(data.PROPERTY_ADDRESS,'address')}</strong> con las siguientes características: <strong>${helpers.placeholderFormatted(data.PROPERTY_DESCRIPTION,'desc')}</strong>.</p>
            <h3>Cláusulas:</h3>
            <p class="clause"><strong>I. Objeto</strong><br>El Vendedor transfiere la propiedad descrita al Comprador.</p>
            <p class="clause"><strong>II. Precio</strong><br>El precio convenido es <strong>${helpers.placeholderWithPrefix(data.PRICE_AMOUNT,'$')}</strong>, que el Comprador paga de la siguiente manera: <strong>${helpers.placeholderFormatted(data.PAYMENT_TYPE,'short')}</strong>.</p>
            <p class="clause"><strong>III. Entrega</strong><br>La entrega material y jurídica se realiza en este acto.</p>
            <p class="clause"><strong>IV. Impuestos y Gastos</strong><br>El impuesto y costos de registro serán asumidos por el Comprador.</p>
            <p class="clause"><strong>V. Garantía</strong><br>El Vendedor garantiza la propiedad y posesión pacífica.</p>
            <p class="clause"><strong>VI. Jurisdicción</strong><br>Las partes se someten a los tribunales competentes de <strong>${helpers.placeholderFormatted(data.JURISDICTION,'short')}</strong>.</p>
            <div class="sign-line">
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Firma del Vendedor</span></div>
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Firma del Comprador</span></div>
            </div>
          </div>
        `;
      } else {
        return `
          <div class="contract-document contract-preview dimmed">
            <h2>${escapeHtml(this.title.en)}</h2>
            <p>In <strong>${helpers.placeholderFormatted(data.CITY,'city')}</strong> on <strong>${helpers.placeholderFormattedDate(data.DATE)}</strong>.</p>
            <p>Appear: <strong>${helpers.placeholderFormatted(data.SELLER_NAME,'name')}</strong> (the "Seller") and <strong>${helpers.placeholderFormatted(data.BUYER_NAME,'name')}</strong> (the "Buyer").</p>
            <h3>Declarations:</h3>
            <p>The Seller declares to be the legal owner of the property (${helpers.placeholderFormatted(data.PROPERTY_TYPE,'short')}) located at <strong>${helpers.placeholderFormatted(data.PROPERTY_ADDRESS,'address')}</strong> with the following characteristics: <strong>${helpers.placeholderFormatted(data.PROPERTY_DESCRIPTION,'desc')}</strong>.</p>
            <h3>Clauses:</h3>
            <p class="clause"><strong>I. Object</strong><br>The Seller transfers the property described to the Buyer.</p>
            <p class="clause"><strong>II. Price</strong><br>The agreed price is <strong>${helpers.placeholderWithPrefix(data.PRICE_AMOUNT,'$')}</strong>, which the Buyer pays in the following manner: <strong>${helpers.placeholderFormatted(data.PAYMENT_TYPE,'short')}</strong>.</p>
            <p class="clause"><strong>III. Delivery</strong><br>The material and legal delivery is carried out at this moment.</p>
            <p class="clause"><strong>IV. Taxes and Expenses</strong><br>The real estate acquisition tax and registration fees to the Public Property Registry shall be borne by the Buyer.</p>
            <p class="clause"><strong>V. Guarantee</strong><br>The Seller guarantees ownership and peaceful possession of the transferred property.</p>
            <p class="clause"><strong>VI. Jurisdiction</strong><br>The parties submit to the competent courts of <strong>${helpers.placeholderFormatted(data.JURISDICTION,'short')}</strong>.</p>
            <div class="sign-line">
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Seller's Signature</span></div>
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Buyer's Signature</span></div>
            </div>
          </div>
        `;
      }
    }
  },

  lease: {
    title: { en: "Lease Contract", es: "Contrato de Arrendamiento" },
    fields: [
      { name:"CITY", label:"City", type:"text", required:true },
      { name:"DATE_FULL", label:"Date", type:"date", required:true },
      { name:"LESSOR_NAME", label:"Lessor Full Name", type:"text", required:true },
      { name:"LESSEE_NAME", label:"Lessee Full Name", type:"text", required:true },
      { name:"PROPERTY_ADDRESS", label:"Property Address", type:"text", required:true },
      { name:"DURATION_MONTHS", label:"Duration (months)", type:"number", required:true },
      { name:"RENT_AMOUNT", label:"Rent Amount", type:"number", prefix:"$", required:true },
      { name:"RENT_AMOUNT_WORDS", label:"Rent Amount in Words", type:"text", readonly:true, required:true },
      { name:"JURISDICTION", label:"Jurisdiction", type:"text", required:true }
    ],
    template: function(data, lang) {
      if (lang === 'es') {
        return `
          <div class="contract-document contract-preview dimmed">
            <h2>${escapeHtml(this.title.es)}</h2>
            <p>Comparecen: <strong>${helpers.placeholderFormatted(data.LESSOR_NAME,'name')}</strong> (el "Arrendador") y <strong>${helpers.placeholderFormatted(data.LESSEE_NAME,'name')}</strong> (el "Arrendatario").</p>
            <h3>Cláusulas:</h3>
            <p class="clause"><strong>I. Objeto</strong><br>El Arrendador da en arrendamiento al Arrendatario el bien ubicado en ${helpers.placeholderFormatted(data.PROPERTY_ADDRESS,'address')}.</p>
            <p class="clause"><strong>II. Duración</strong><br>El plazo será de ${helpers.placeholderFormatted(data.DURATION_MONTHS,'short')} meses.</p>
            <p class="clause"><strong>III. Renta</strong><br>La renta mensual será de <strong>${helpers.placeholderWithPrefix(data.RENT_AMOUNT,'$')}</strong> (${helpers.placeholderFormatted(data.RENT_AMOUNT_WORDS,'long')}).</p>
            <p class="clause"><strong>IV. Jurisdicción</strong><br>Las partes convienen que las controversias se resolverán ante los tribunales de ${helpers.placeholderFormatted(data.JURISDICTION,'short')}.</p>
            <div class="sign-line">
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Firma del Arrendador</span></div>
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Firma del Arrendatario</span></div>
            </div>
          </div>
        `;
      } else {
        return `
          <div class="contract-document contract-preview dimmed">
            <h2>${escapeHtml(this.title.en)}</h2>
            <p>The following parties appear: <strong>${helpers.placeholderFormatted(data.LESSOR_NAME,'name')}</strong> (the “Lessor”) and <strong>${helpers.placeholderFormatted(data.LESSEE_NAME,'name')}</strong> (the “Lessee”).</p>
            <h3>Clauses:</h3>
            <p class="clause"><strong>I. Object</strong><br>The Lessor leases to the Lessee the property located at ${helpers.placeholderFormatted(data.PROPERTY_ADDRESS,'address')}.</p>
            <p class="clause"><strong>II. Duration</strong><br>The lease term shall be ${helpers.placeholderFormatted(data.DURATION_MONTHS,'short')} months.</p>
            <p class="clause"><strong>III. Rent</strong><br>The monthly rent shall be <strong>${helpers.placeholderWithPrefix(data.RENT_AMOUNT,'$')}</strong> (${helpers.placeholderFormatted(data.RENT_AMOUNT_WORDS,'long')}).</p>
            <p class="clause"><strong>IV. Jurisdiction</strong><br>The parties agree that any disputes arising from this contract shall be resolved in the courts of ${helpers.placeholderFormatted(data.JURISDICTION,'short')}.</p>
            <div class="sign-line">
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Lessor's Signature</span></div>
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Lessee's Signature</span></div>
            </div>
          </div>
        `;
      }
    }
  },

  mortgage: {
    title: { en: "Mortgage Contract", es: "Contrato de Hipoteca" },
    fields: [
      { name:"CREDITOR_NAME", label:"Creditor Name", type:"text", required:true },
      { name:"DEBTOR_NAME", label:"Debtor Name", type:"text", required:true },
      { name:"PROPERTY_ADDRESS", label:"Property Address", type:"text", required:true },
      { name:"AMOUNT", label:"Amount", type:"number", prefix:"$", required:true },
      { name:"JURISDICTION", label:"Jurisdiction", type:"text", required:true },
      { name:"DATE", label:"Date", type:"date", required:true }
    ],
    template: function(data, lang) {
      if (lang === 'es') {
        return `
          <div class="contract-document contract-preview dimmed">
            <h2>${escapeHtml(this.title.es)}</h2>
            <p>Comparecen: <strong>${helpers.placeholderFormatted(data.CREDITOR_NAME,'name')}</strong> (Acreedor) y <strong>${helpers.placeholderFormatted(data.DEBTOR_NAME,'name')}</strong> (Deudor).</p>
            <h3>Cláusulas:</h3>
            <p class="clause"><strong>I. Objeto</strong><br>El acreedor constituye una garantía hipotecaria sobre el bien ubicado en ${helpers.placeholderFormatted(data.PROPERTY_ADDRESS,'address')}.</p>
            <p class="clause"><strong>II. Importe</strong><br>El crédito garantizado asciende a <strong>${helpers.placeholderWithPrefix(data.AMOUNT,'$')}</strong>.</p>
            <p class="clause"><strong>III. Duración</strong><br>La hipoteca subsistirá hasta el pago total conforme al contrato de préstamo.</p>
            <p class="clause"><strong>IV. Jurisdicción</strong><br>Las partes se someten a los tribunales de ${helpers.placeholderFormatted(data.JURISDICTION,'short')}.</p>
            <p class="clause">Firmado en ${helpers.placeholderFormattedDate(data.DATE)}.</p>
            <div class="sign-line">
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Firma del Acreedor</span></div>
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Firma del Deudor</span></div>
            </div>
          </div>
        `;
      } else {
        return `
          <div class="contract-document contract-preview dimmed">
            <h2>${escapeHtml(this.title.en)}</h2>
            <p>They appear: <strong>${helpers.placeholderFormatted(data.CREDITOR_NAME,'name')}</strong> (Creditor) and <strong>${helpers.placeholderFormatted(data.DEBTOR_NAME,'name')}</strong> (Debtor).</p>
            <h3>Clauses:</h3>
            <p class="clause"><strong>I. Object</strong><br>The creditor grants a mortgage security over the property located at ${helpers.placeholderFormatted(data.PROPERTY_ADDRESS,'address')}.</p>
            <p class="clause"><strong>II. Amount</strong><br>The secured credit amount is <strong>${helpers.placeholderWithPrefix(data.AMOUNT,'$')}</strong>.</p>
            <p class="clause"><strong>III. Duration</strong><br>The parties agree the mortgage shall remain until full repayment as set in the loan agreement.</p>
            <p class="clause"><strong>IV. Jurisdiction</strong><br>The parties submit to the courts of ${helpers.placeholderFormatted(data.JURISDICTION,'short')}.</p>
            <p class="clause">Signed in ${helpers.placeholderFormattedDate(data.DATE)}.</p>
            <div class="sign-line">
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Creditor's Signature</span></div>
              <div class="sign-slot"><span class="signature"></span><span class="signature-label">Debtor's Signature</span></div>
            </div>
          </div>
        `;
      }
    }
  }
};

/* ---------------------------
   Helpers
   --------------------------- */
function escapeHtml(unsafe) {
  if (unsafe == null) return "";
  return String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function formatDate(isoStr) {
  if (!isoStr) return "";
  const parts = String(isoStr).split("-");
  if (parts.length===3) {
    const [y,m,d] = parts;
    return `${m.padStart(2,'0')}/${d.padStart(2,'0')}/${y}`;
  }
  return isoStr;
}
function numberToWords(amount) {
  if (amount==="" || amount==null) return "";
  let num = Number(amount);
  if (isNaN(num)) return "";
  if (num === 0) return "zero dollars";
  const dollars = Math.floor(Math.abs(num));
  const cents = Math.round((Math.abs(num) - dollars) * 100);
  const ones = ["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
  const tens = ["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];
  function chunkToWords(n) {
    let words="";
    if (n>=100){ words += ones[Math.floor(n/100)] + " hundred"; n = n%100; if(n) words += " "; }
    if (n>=20){ words += tens[Math.floor(n/10)]; if(n%10) words += "-" + ones[n%10]; }
    else if (n>0) words += ones[n];
    return words;
  }
  function largeNumberToWords(n) {
    if (n===0) return "zero";
    const scales = [""," thousand"," million"," billion"," trillion"];
    let words=""; let scale=0;
    while(n>0){
      const chunk = n%1000;
      if(chunk){ const cw = chunkToWords(chunk); words = (cw + scales[scale] + (words ? " " + words : "")).trim(); }
      n = Math.floor(n/1000); scale++;
    }
    return words;
  }
  let result = largeNumberToWords(dollars) + (dollars===1 ? " dollar" : " dollars");
  if (cents>0) result += " and " + (cents<10 ? "0"+cents : cents) + "/100 cents";
  if (num < 0) result = "minus " + result;
  return result;
}

// dynamic placeholder length
function dynamicUnderscoresFor(typeOrName, explicitVal) {
  const map = { name:30, address:48, city:18, short:14, long:42, amt:12, desc:40, date:12 };
  let len = 12;
  if (explicitVal && String(explicitVal).trim().length>0) {
    return escapeHtml(String(explicitVal));
  }
  if (typeOrName && map[typeOrName]) len = map[typeOrName];
  const underscoresCount = Math.max(6, Math.min(60, Math.floor(len/1.2)));
  return '<span class="placeholder">' + '_'.repeat(underscoresCount) + '</span>';
}
function placeholderFormatted(val, kind='short') { if (val==null || String(val).trim()==='') return dynamicUnderscoresFor(kind); return `<span>${escapeHtml(String(val))}</span>`; }
function placeholderFormattedDate(val){ if (!val) return dynamicUnderscoresFor('date'); return `<span>${escapeHtml(formatDate(val))}</span>`; }
function placeholderWithPrefix(val, prefix='$'){ if (val==null || String(val).trim()==='') return dynamicUnderscoresFor('amt'); return `<span>${escapeHtml(prefix)}${escapeHtml(String(val))}</span>`; }

/* ---------------------------
   DOM refs & Form builder
   --------------------------- */
const contractTypeSelect = document.getElementById('contractType');
const regionSelect = document.getElementById('regionSelect');
const courtSelect = document.getElementById('courtSelect');
const languageSelect = document.getElementById('languageSelect');
const form = document.getElementById('contractForm');
const previewSection = document.getElementById('previewSection');
const showPreviewBtn = document.getElementById('showPreviewBtn');
const downloadPdfBtn = document.getElementById('downloadPdfBtn');
const previewPopup = document.getElementById('previewPopup');
const popupContent = document.getElementById('popupContent');
const closePreviewBtn = document.getElementById('closePreviewBtn');

let currentContractType = null;

// fill court options when region changes
regionSelect.addEventListener('change', () => {
  const region = regionSelect.value;
  courtSelect.innerHTML = '<option value="">-- Select Court --</option>';
  if (!region || !regionCourtMap[region]) return;
  regionCourtMap[region].forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    courtSelect.appendChild(opt);
  });
  // update hidden jurisdiction field(s) when court changes via event below
});

// when court or region changes, update any visible JURISDICTION input if present
courtSelect.addEventListener('change', () => {
  const selectedCourt = courtSelect.value || '';
  const existingJur = form.elements['JURISDICTION'];
  if (existingJur) existingJur.value = selectedCourt;
  renderLivePreview();
});
regionSelect.addEventListener('change', () => { renderLivePreview(); });

/* create input elements for contract fields */
function createInput(field) {
  const wrapper = document.createElement('div');
  wrapper.style.marginTop = '10px';
  const label = document.createElement('label');
  label.htmlFor = field.name; label.className = field.required ? 'required' : ''; label.textContent = field.label;
  let input;
  if (field.type === 'select') {
    input = document.createElement('select'); input.id = field.name; input.name = field.name;
    const def = document.createElement('option'); def.value = ''; def.textContent = '-- Select --'; input.appendChild(def);
    (field.options || []).forEach(opt => { const o = document.createElement('option'); o.value = opt; o.textContent = opt; input.appendChild(o); });
  } else if (field.type === 'date') {
    input = document.createElement('input'); input.type = 'date'; input.id = field.name; input.name = field.name; if (field.required) input.required = true;
  } else {
    input = document.createElement('input'); input.type = field.type === 'number' ? 'number' : 'text'; input.id = field.name; input.name = field.name;
    if (field.prefix) input.dataset.prefix = field.prefix;
    if (field.required) input.required = true;
    if (field.type === 'number') input.min = 0;
    input.placeholder = field.label;
    if (field.readonly) { input.readOnly = true; input.style.background = '#f4f4f4'; }
  }
  wrapper.appendChild(label);
  if (field.prefix && input.type !== 'select') {
    const cont = document.createElement('div'); cont.style.display='flex'; cont.style.gap='8px'; cont.style.alignItems='center';
    const p = document.createElement('span'); p.textContent = field.prefix; p.style.fontWeight='700';
    cont.appendChild(p); cont.appendChild(input); wrapper.appendChild(cont);
  } else wrapper.appendChild(input);

  if (field.type === 'date') { const note = document.createElement('div'); note.className='muted-small'; note.textContent='Use the calendar to pick a date. Displayed MM/DD/YYYY.'; wrapper.appendChild(note); }
  return wrapper;
}

/* build form when contract selected */
function buildForm(contractType) {
  // clear any previously-added dynamic fields (except region/court/language controls)
  // We'll re-render the dynamic fields below
  // Keep the top region/court/language controls; clear everything else
  // So rebuild the form innerHTML to include those controls + dynamic fields
  form.innerHTML = `
    <div style="display:flex; gap:10px; align-items:center;">
      <div style="flex:1;">
        <label for="regionSelect">Region</label>
        <select id="regionSelect">
          <option value="">-- Select Region --</option>
          <option value="Texas">Texas</option>
          <option value="Mexico">Mexico</option>
        </select>
      </div>
      <div style="flex:1;">
        <label for="courtSelect">Court</label>
        <select id="courtSelect"><option value="">-- Select Court --</option></select>
      </div>
    </div>
    <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
      <div style="flex:1;">
        <label for="languageSelect">Contract Language</label>
        <select id="languageSelect" title="Contract wording language">
          <option value="en">English</option>
          <option value="es">Español</option>
        </select>
      </div>
      <div style="flex:1;">
        <label class="muted-small"> </label>
        <div class="muted-small">Language affects contract text only.</div>
      </div>
    </div>
    <div id="dynamicFieldsNote" class="muted-small" style="margin-top:10px;"></div>
  `;

  // rewire region/court/language DOM references because we replaced them
  // (reacquire elements)
  const newRegion = document.getElementById('regionSelect');
  const newCourt = document.getElementById('courtSelect');
  const newLang = document.getElementById('languageSelect');

  // when region changes, populate court list and update JURISDICTION value
  newRegion.addEventListener('change', () => {
    const region = newRegion.value;
    newCourt.innerHTML = '<option value="">-- Select Court --</option>';
    if (region && regionCourtMap[region]) {
      regionCourtMap[region].forEach(c => {
        const o = document.createElement('option'); o.value = c; o.textContent = c; newCourt.appendChild(o);
      });
    }
    // update JURISDICTION field if present
    const jur = form.elements['JURISDICTION'];
    if (jur) jur.value = newCourt.value || '';
    renderLivePreview();
  });

  newCourt.addEventListener('change', () => {
    const jur = form.elements['JURISDICTION'];
    if (jur) jur.value = newCourt.value || '';
    renderLivePreview();
  });

  newLang.addEventListener('change', () => { renderLivePreview(); });

  // now append dynamic fields for chosen contract
  if (!contractType || !contracts[contractType]) {
    previewSection.innerHTML = '<em>Select a contract and fill out the form to see the live preview here.</em>';
    return;
  }

  currentContractType = contractType;
  const fields = contracts[contractType].fields;
  fields.forEach(field => {
    // For JURISDICTION field, rather than create a free-text, create a hidden input that will be set by courtSelect
    if (field.name === 'JURISDICTION') {
      // create a hidden text input but also show a small note
      const hidden = document.createElement('input');
      hidden.type = 'text'; hidden.name = 'JURISDICTION'; hidden.id = 'JURISDICTION'; hidden.value = courtSelect.value || '';
      hidden.style.display = 'none';
      form.appendChild(hidden);
      return;
    }
    form.appendChild(createInput(field));
  });

  // If there is a RENT_AMOUNT and RENT_AMOUNT_WORDS, ensure words is readonly and updated
  const rentEl = form.elements['RENT_AMOUNT'];
  const rentWordsEl = form.elements['RENT_AMOUNT_WORDS'];
  if (rentEl && rentWordsEl) {
    rentWordsEl.readOnly = true; rentWordsEl.style.background = '#f4f4f4';
    const updateWords = () => { rentWordsEl.value = numberToWords(rentEl.value); renderLivePreview(); };
    rentEl.addEventListener('input', updateWords);
    updateWords();
  }

  // wire up all inputs to live update
  Array.from(form.elements).forEach(el => {
    if (!el) return;
    el.addEventListener('input', () => renderLivePreview());
    el.addEventListener('change', () => renderLivePreview());
  });

  showPreviewBtn.disabled = false;
  downloadPdfBtn.disabled = false;

  // initial preview render
  renderLivePreview();
}

/* get current form data */
function getFormData() {
  if (!currentContractType) return {};
  const data = {};
  contracts[currentContractType].fields.forEach(f => {
    const el = form.elements[f.name];
    data[f.name] = el ? el.value : '';
  });
  // ensure JURISDICTION pulls from courtSelect if available
  const courtVal = document.getElementById('courtSelect') ? document.getElementById('courtSelect').value : '';
  if (data['JURISDICTION'] === '' && courtVal) data['JURISDICTION'] = courtVal;
  return data;
}

/* helpers object passed into templates for placeholder rendering */
const helpers = {
  placeholderFormatted: placeholderFormatted,
  placeholderFormattedDate: placeholderFormattedDate,
  placeholderWithPrefix: placeholderWithPrefix
};

/* render live preview */
function renderLivePreview() {
  if (!currentContractType) {
    previewSection.innerHTML = '<em>Select a contract and fill out the form to see the live preview here.</em>';
    return;
  }
  const data = getFormData();
  const lang = document.getElementById('languageSelect') ? document.getElementById('languageSelect').value : 'en';
  const tpl = contracts[currentContractType].template;
  // attach helpers to global scope used inside templates
  previewSection.innerHTML = tpl.call(contracts[currentContractType], data, lang);
}

/* events */
contractTypeSelect.addEventListener('change', () => buildForm(contractTypeSelect.value));

showPreviewBtn.addEventListener('click', () => {
  renderLivePreview();
  popupContent.innerHTML = previewSection.innerHTML;
  previewPopup.style.display = 'flex';
});
closePreviewBtn.addEventListener('click', () => previewPopup.style.display = 'none');

downloadPdfBtn.addEventListener('click', async () => {
  renderLivePreview();
  popupContent.innerHTML = previewSection.innerHTML;
  await new Promise(r => setTimeout(r, 80));
  const canvas = await html2canvas(popupContent, { scale: 2, useCORS: true });
  const imgData = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
  const pdfWidth = pdf.internal.pageSize.getWidth();
  const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
  pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
  pdf.save(`${contracts[currentContractType].title.en || 'contract'}.pdf`);
});

/* Optional: preselect nothing (user chooses) */
// contractTypeSelect.value = 'realEstate'; buildForm('realEstate');

</script>
</body>
</html>